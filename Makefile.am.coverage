
# Coverage targets

if HAVE_GCOV

.PHONY: clean-gcda
clean-gcda:
	@echo Removing old coverage results
	-find $(top_builddir) -name '*.gcda' -print | xargs rm

.PHONY: clean-output-folder
clean-output-folder:
	@echo Removing old html results
	-rm -rf coverage/*

.PHONY: coverage-html generate-coverage-html clean-coverage-html
coverage: clean-gcda clean-output-folder
	-$(MAKE) $(AM_MAKEFLAGS) -k test
	$(MAKE) $(AM_MAKEFLAGS) generate-coverage-html

generate-coverage-html:
	@echo Collecting coverage data
	$(LCOV) --directory $(top_builddir)/src --capture --output-file coverage.info --no-checksum --compat-libtool --no-external --gcov-tool $(GCOV)
	$(GENHTML) --output-directory coverage --title "Code Coverage" --legend --show-details coverage.info

clean-coverage-html: clean-gcda
	-$(LCOV) --directory $(top_builddir) -z --gcov-tool $(GCOV)
	-rm -rf coverage.info

clean-local: clean-coverage-html

endif # HAVE_GCOV
